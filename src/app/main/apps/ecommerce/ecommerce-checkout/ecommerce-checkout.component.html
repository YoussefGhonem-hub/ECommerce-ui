<div class="content-wrapper container-xxl p-0">
  <app-content-header [contentHeader]="contentHeader"></app-content-header>
  <div class="content-body">
    <div class="bs-stepper checkout-tab-steps" id="checkoutStepper">
      <!-- Wizard starts -->
      <div class="bs-stepper-header">
        <div class="step" data-target="#step-cart">
          <button type="button" class="step-trigger">
            <span class="bs-stepper-box">
              <i data-feather="shopping-cart" class="font-medium-3"></i>
            </span>
            <span class="bs-stepper-label">
              <span class="bs-stepper-title">Cart</span>
              <span class="bs-stepper-subtitle">Your Cart Items</span>
            </span>
          </button>
        </div>
        <div class="line">
          <i data-feather="chevron-right" class="font-medium-2"></i>
        </div>
        <div class="step" data-target="#step-address">
          <button type="button" class="step-trigger">
            <span class="bs-stepper-box">
              <i data-feather="home" class="font-medium-3"></i>
            </span>
            <span class="bs-stepper-label">
              <span class="bs-stepper-title">Address</span>
              <span class="bs-stepper-subtitle">Enter Your Address</span>
            </span>
          </button>
        </div>
        <div class="line">
          <i data-feather="chevron-right" class="font-medium-2"></i>
        </div>
        <div class="step" data-target="#step-summary">
          <button type="button" class="step-trigger">
            <span class="bs-stepper-box">
              <i data-feather="check-circle" class="font-medium-3"></i>
            </span>
            <span class="bs-stepper-label">
              <span class="bs-stepper-title">Summary</span>
              <span class="bs-stepper-subtitle">Review & Checkout</span>
            </span>
          </button>
        </div>
      </div>
      <!-- Wizard ends -->

      <div class="bs-stepper-content">
        <!-- Checkout Place order starts -->
        <div id="step-cart" class="content">
          <div id="place-order" class="list-view product-checkout">
            <!-- Checkout Place Order Left starts -->
            <div class="checkout-items">
              <ng-container *ngFor="let cartItem of paginatedCartItems">
                <app-ecommerce-checkout-item [product]="cartItem" (cartRefresh)="onCartRefresh()"
                  (quantityUpdated)="onItemQuantityUpdate($event)">
                </app-ecommerce-checkout-item>
              </ng-container>

              <!-- Empty state when no items -->
              <div *ngIf="cartItems.length === 0" class="text-center py-4">
                <h5 class="text-muted">Your cart is empty</h5>
                <p class="text-muted">Add some items to your cart to proceed with checkout.</p>
              </div>

              <!-- Pagination Controls -->
              <div *ngIf="totalPages > 1" class="d-flex justify-content-center mt-3">
                <ngb-pagination [(page)]="currentPage" [pageSize]="itemsPerPage" [collectionSize]="cartItems.length"
                  [maxSize]="5" [rotate]="true" [boundaryLinks]="true" (pageChange)="goToPage(event)">
                </ngb-pagination>
              </div>

              <!-- Pagination Info -->
              <div *ngIf="cartItems.length > 0" class="text-center mt-2">
                <small class="text-muted">
                  Showing {{ (currentPage - 1) * itemsPerPage + 1 }} -
                  {{ Math.min(currentPage * itemsPerPage, cartItems.length) }}
                  of {{ cartItems.length }} items
                </small>
              </div>
            </div>
            <!-- Checkout Place Order Left ends -->

            <!-- Checkout Place Order Right starts -->
            <div class="checkout-options">
              <div class="card">
                <div class="card-body">
                  <label class="section-label mb-1">Coupons</label>
                  <div class="coupons input-group input-group-merge mb-2">
                    <input type="text" class="form-control" placeholder="Enter coupon code" aria-label="Coupon Code"
                      [(ngModel)]="couponCode" [disabled]="isApplyingCoupon" />
                    <div class="input-group-append">
                      <button class="btn btn-primary" type="button" (click)="applyCoupon()"
                        [disabled]="isApplyingCoupon || !couponCode">
                        <span *ngIf="isApplyingCoupon" class="spinner-border spinner-border-sm mr-1"></span>
                        {{ isApplyingCoupon ? 'Applying...' : 'Apply' }}
                      </button>
                    </div>
                  </div>

                  <!-- Available Coupons - Hidden -->
                  <!-- <div *ngIf="availableCoupons.length > 0" class="available-coupons mb-2">
                    <small class="text-muted mb-1 d-block">Available Coupons:</small>
                    <div class="row">
                      <div class="col-12" *ngFor="let coupon of availableCoupons.slice(0, 3)">
                        <div class="card card-body p-2 mb-1 border">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong class="text-primary">{{ coupon.code }}</strong>
                              <small class="d-block text-muted">{{ getCouponDescription(coupon) }}</small>
                              <small class="text-success" *ngIf="coupon.freeShipping">+ Free Shipping</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary"
                              (click)="couponCode = coupon.code; applyCoupon()">
                              Apply
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> -->

                  <!-- Applied Coupon Display -->
                  <div *ngIf="checkoutData?.appliedCoupon" class="applied-coupon mb-2">
                    <div class="card card-body p-2 border-success bg-light-success">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong class="text-success">{{ checkoutData.appliedCoupon.code }}</strong>
                          <small class="d-block text-muted">{{ getCouponDescription(checkoutData.appliedCoupon)
                            }}</small>
                          <small class="text-success" *ngIf="checkoutData.appliedCoupon.freeShipping">+ Free Shipping
                            Applied</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" (click)="removeCoupon()"
                          [disabled]="isApplyingCoupon">
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>

                  <hr />
                  <div class="price-details">
                    <h6 class="price-title">Price Details</h6>
                    <ul class="list-unstyled">
                      <li class="price-detail">
                        <div class="detail-title">Subtotal ({{ cartItems?.length || 0 }} items)</div>
                        <div class="detail-amt">{{ checkoutData?.subTotal || 0 }} EGP</div>
                      </li>
                      <li class="price-detail" *ngIf="checkoutData?.discountTotal > 0">
                        <div class="detail-title">Discount</div>
                        <div class="detail-amt discount-amt text-success">-{{ checkoutData?.discountTotal || 0 }} EGP
                        </div>
                      </li>
                      <li class="price-detail">
                        <div class="detail-title">Shipping
                          <span *ngIf="checkoutData?.freeShippingApplied" class="text-success">(Free)</span>
                        </div>
                        <div class="detail-amt" [class.discount-amt]="checkoutData?.freeShippingApplied"
                          [class.text-success]="checkoutData?.freeShippingApplied">
                          {{ checkoutData?.freeShippingApplied ? 'Free' : (checkoutData?.shippingTotal || 0) + ' EGP' }}
                        </div>
                      </li>
                    </ul>
                    <hr />
                    <ul class="list-unstyled">
                      <li class="price-detail">
                        <div class="detail-title detail-total">Total</div>
                        <div class="detail-amt font-weight-bolder">{{ checkoutData?.total || 0 }} EGP</div>
                      </li>
                    </ul>
                    <button type="button" class="btn btn-primary btn-block btn-next place-order" (click)="nextStep()"
                      rippleEffect>
                      Place Order
                    </button>
                  </div>
                </div>
              </div>
              <!-- Checkout Place Order Right ends -->
            </div>
          </div>
          <!-- Checkout Place order Ends -->
        </div>
        <!-- Checkout Customer Address Starts -->
        <div id="step-address" class="content">
          <!-- Existing Addresses Section -->
          <div class="card" *ngIf="myAddresses.length > 0">
            <div class="card-header">
              <h4 class="card-title">Choose Existing Address</h4>
              <p class="card-text text-muted mt-25">Select from your saved addresses</p>
            </div>
            <div class="card-body">
              <div class="row" *ngIf="!isLoadingAddresses; else loadingAddresses">
                <div class="col-md-6 col-sm-12 mb-3" *ngFor="let addr of paginatedAddresses">
                  <div class="card border customer-card" [class.border-primary]="selectedAddressId === addr.id"
                    [class.bg-light-primary]="selectedAddressId === addr.id">
                    <div class="card-body p-3">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                          <h6 class="card-title mb-1">
                            <i data-feather="user" class="mr-50 font-medium-4"></i>
                            {{ addr.fullName }}
                          </h6>
                          <p class="card-text small mb-1">
                            <i data-feather="map-pin" class="mr-25"></i>
                            {{ addr.street }}<br>
                            <span *ngIf="addr.houseNo" class="ml-25">{{ addr.houseNo }}, </span>
                            <span class="ml-25">{{ addr.cityNameEn }}, {{ addr.countryNameEn }}</span>
                          </p>
                          <p class="card-text small mb-2">
                            <i data-feather="phone" class="mr-25"></i>
                            {{ addr.mobileNumber }}
                          </p>
                          <span class="badge badge-light-success" *ngIf="addr.isDefault">
                            <i data-feather="check" class="mr-25"></i>Default
                          </span>
                        </div>
                      </div>
                      <button type="button" class="btn btn-sm w-100" [class.btn-primary]="selectedAddressId === addr.id"
                        [class.btn-outline-primary]="selectedAddressId !== addr.id" (click)="selectAddress(addr.id)">
                        <i data-feather="check-circle" class="mr-50" *ngIf="selectedAddressId === addr.id"></i>
                        <i data-feather="home" class="mr-50" *ngIf="selectedAddressId !== addr.id"></i>
                        {{ selectedAddressId === addr.id ? 'Selected Address' : 'Deliver To This Address' }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <ng-template #loadingAddresses>
                <div class="text-center py-4">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Loading addresses...</span>
                  </div>
                  <p class="mt-2 mb-0 text-muted">Loading your addresses...</p>
                </div>
              </ng-template>

              <!-- Address Pagination Controls -->
              <div *ngIf="totalAddressPages > 1" class="d-flex justify-content-center mt-3">
                <ngb-pagination [(page)]="currentAddressPage" [pageSize]="addressItemsPerPage"
                  [collectionSize]="myAddresses.length" [maxSize]="5" [rotate]="true" [boundaryLinks]="true"
                  (pageChange)="goToAddressPage($event)">
                </ngb-pagination>
              </div>

              <!-- Address Pagination Info -->
              <div *ngIf="myAddresses.length > 0" class="text-center mt-2">
                <small class="text-muted">
                  Showing {{ (currentAddressPage - 1) * addressItemsPerPage + 1 }} -
                  {{ Math.min(currentAddressPage * addressItemsPerPage, myAddresses.length) }}
                  of {{ myAddresses.length }} addresses
                </small>
              </div>

              <div class="text-center mt-3">
                <button type="button" class="btn btn-outline-secondary" (click)="toggleNewAddressForm()">
                  <i data-feather="plus" class="mr-50"></i>
                  {{ isAddingNewAddress ? 'Cancel New Address' : 'Add New Address' }}
                </button>
              </div>
            </div>
          </div>

          <!-- New Address Form -->
          <div class="card" *ngIf="isAddingNewAddress || myAddresses.length === 0">
            <div class="card-header flex-column align-items-start">
              <h4 class="card-title">
                <i data-feather="plus-circle" class="mr-50"></i>
                {{ myAddresses.length === 0 ? 'Add Your First Address' : 'Add New Address' }}
              </h4>
              <p class="card-text text-muted mt-25">
                Fill in the details below and click "Deliver to this address" to proceed
              </p>
            </div>
            <div class="card-body">
              <form [formGroup]="addressForm" (ngSubmit)="validateAddressAndProceed()">
                <div class="row">
                  <div class="col-md-12 col-sm-12">
                    <div class="form-group mb-2">
                      <label for="checkout-name" class="form-label">Full Name <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i data-feather="user"></i></span>
                        </div>
                        <input type="text" id="checkout-name" class="form-control"
                          [class.is-invalid]="getFormControl('fullName')?.invalid && getFormControl('fullName')?.touched"
                          formControlName="fullName" placeholder="John Doe" />
                      </div>
                      <div *ngIf="getFormControl('fullName')?.invalid && getFormControl('fullName')?.touched"
                        class="invalid-feedback d-block">
                        <small *ngIf="getFormControl('fullName')?.errors?.['required']">Full name is required</small>
                        <small *ngIf="getFormControl('fullName')?.errors?.['minlength']">Full name must be at least 2
                          characters</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12">
                    <div class="form-group mb-2">
                      <label for="checkout-number" class="form-label">Mobile Number <span
                          class="text-danger">*</span></label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i data-feather="phone"></i></span>
                        </div>
                        <input type="text" id="checkout-number" class="form-control"
                          [class.is-invalid]="getFormControl('mobileNumber')?.invalid && getFormControl('mobileNumber')?.touched"
                          formControlName="mobileNumber" placeholder="+1234567890" />
                      </div>
                      <div *ngIf="getFormControl('mobileNumber')?.invalid && getFormControl('mobileNumber')?.touched"
                        class="invalid-feedback d-block">
                        <small *ngIf="getFormControl('mobileNumber')?.errors?.['required']">Mobile number is
                          required</small>
                        <small *ngIf="getFormControl('mobileNumber')?.errors?.['pattern']">Please enter a valid mobile
                          number</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12">
                    <div class="form-group mb-2">
                      <label for="checkout-country" class="form-label">Country <span
                          class="text-danger">*</span></label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i data-feather="globe"></i></span>
                        </div>
                        <select id="checkout-country" class="form-control"
                          [class.is-invalid]="getFormControl('countryId')?.invalid && getFormControl('countryId')?.touched"
                          formControlName="countryId" (change)="onCountryChange($event.target.value)"
                          [disabled]="isLoadingCountries">
                          <option value="" disabled>{{ isLoadingCountries ? 'Loading...' : 'Select Country' }}</option>
                          <option [value]="country.id" *ngFor="let country of countries">{{ country.nameEn }}</option>
                        </select>
                      </div>
                      <div *ngIf="getFormControl('countryId')?.invalid && getFormControl('countryId')?.touched"
                        class="invalid-feedback d-block">
                        <small *ngIf="getFormControl('countryId')?.errors?.['required']">Country is required</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12">
                    <div class="form-group mb-2">
                      <label for="checkout-city" class="form-label">City <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i data-feather="map-pin"></i></span>
                        </div>
                        <select id="checkout-city" class="form-control"
                          [class.is-invalid]="getFormControl('cityId')?.invalid && getFormControl('cityId')?.touched"
                          formControlName="cityId" (change)="onCityChange($event.target.value)"
                          [disabled]="isLoadingCities || !getFormControl('countryId')?.value">
                          <option value="" disabled>
                            {{ isLoadingCities ? 'Loading...' : (getFormControl('countryId')?.value ? 'Select City' :
                            'Select Country First') }}
                          </option>
                          <option [value]="city.id" *ngFor="let city of cities">{{ city.nameEn }}</option>
                        </select>
                      </div>
                      <div *ngIf="getFormControl('cityId')?.invalid && getFormControl('cityId')?.touched"
                        class="invalid-feedback d-block">
                        <small *ngIf="getFormControl('cityId')?.errors?.['required']">City is required</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12">
                    <div class="form-group mb-2">
                      <label for="checkout-street" class="form-label">Street Address <span
                          class="text-danger">*</span></label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i data-feather="map"></i></span>
                        </div>
                        <input type="text" id="checkout-street" class="form-control"
                          [class.is-invalid]="getFormControl('street')?.invalid && getFormControl('street')?.touched"
                          formControlName="street" placeholder="123 Main Street" />
                      </div>
                      <div *ngIf="getFormControl('street')?.invalid && getFormControl('street')?.touched"
                        class="invalid-feedback d-block">
                        <small *ngIf="getFormControl('street')?.errors?.['required']">Street address is required</small>
                        <small *ngIf="getFormControl('street')?.errors?.['minlength']">Street address must be at least 5
                          characters</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 col-sm-12">
                    <div class="form-group mb-2">
                      <label for="checkout-house" class="form-label">House/Flat Number (Optional)</label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i data-feather="home"></i></span>
                        </div>
                        <input type="text" id="checkout-house" class="form-control" formControlName="houseNo"
                          placeholder="Apt 4B, Floor 2" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-block" [disabled]="addressForm.invalid">
                      <i data-feather="map-pin" class="mr-50"></i>
                      Deliver To This Address
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Continue Button for Selected Address -->
          <div class="row mt-3" *ngIf="selectedAddressId && !isAddingNewAddress">
            <div class="col-12">
              <button type="button" class="btn btn-primary btn-block btn-lg" (click)="nextStep()">
                <i data-feather="arrow-right" class="mr-50"></i>
                Continue to Summary
              </button>
            </div>
          </div>
        </div>
        <!-- Checkout Customer Address Ends -->

        <!-- Checkout Summary Starts -->
        <div id="step-summary" class="content">
          <div class="row">
            <div class="col-xl-8 col-md-7 col-12">
              <!-- Order Summary Card -->
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title">
                    <i data-feather="shopping-bag" class="mr-50"></i>
                    Order Summary
                  </h4>
                </div>
                <div class="card-body">
                  <!-- Cart Items Summary -->
                  <div class="order-items mb-3">
                    <h6 class="mb-2">Items ({{ cartItems?.length || 0 }})</h6>
                    <div class="item-summary" *ngFor="let item of cartItems">
                      <div class="d-flex align-items-center mb-2 p-2 border rounded">
                        <!-- Display first image from imageUrls or fallback to mainImagePath -->
                        <img [src]="getItemImage(item)" class="img-fluid rounded mr-2"
                          style="width: 50px; height: 50px; object-fit: cover" [alt]="item.productName">
                        <div class="flex-grow-1">
                          <h6 class="mb-0">{{ item.productName }}</h6>
                          <small class="text-muted">{{ item.brand }}</small>
                          <div class="mt-1">
                            <span class="badge badge-light-primary">Qty: {{ item.quantity }}</span>
                            <span class="badge badge-light-success ml-1">{{ item.subTotal }} EGP</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Delivery Address -->
                  <div class="delivery-address mb-3" *ngIf="getSelectedAddress()">
                    <h6 class="mb-2">
                      <i data-feather="map-pin" class="mr-50"></i>
                      Delivery Address
                    </h6>
                    <div class="card border border-primary bg-light-primary p-3">
                      <h6 class="card-title mb-1">{{ getSelectedAddress()?.fullName }}</h6>
                      <p class="card-text small mb-1">
                        {{ getSelectedAddress()?.street }}<br>
                        <span *ngIf="getSelectedAddress()?.houseNo">{{ getSelectedAddress()?.houseNo }}, </span>
                        {{ getSelectedAddress()?.cityNameEn }}, {{ getSelectedAddress()?.countryNameEn }}
                      </p>
                      <p class="card-text small mb-0">
                        <i data-feather="phone" class="mr-25"></i>
                        {{ getSelectedAddress()?.mobileNumber }}
                      </p>
                    </div>
                  </div>

                  <!-- Applied Coupon -->
                  <div class="applied-coupon-summary" *ngIf="checkoutData?.appliedCoupon">
                    <h6 class="mb-2">
                      <i data-feather="tag" class="mr-50"></i>
                      Applied Coupon
                    </h6>
                    <div class="card border border-success bg-light-success p-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong class="text-success">{{ checkoutData.appliedCoupon.code }}</strong>
                          <small class="d-block text-muted">{{ getCouponDescription(checkoutData.appliedCoupon)
                            }}</small>
                        </div>
                        <span class="badge badge-success">
                          <i data-feather="check" class="mr-25"></i>
                          Applied
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-4 col-md-5 col-12">
              <!-- Price Details & Checkout -->
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title">
                    <i data-feather="dollar-sign" class="mr-50"></i>
                    Price Details
                  </h4>
                </div>
                <div class="card-body">
                  <div class="price-details">
                    <ul class="list-unstyled">
                      <li class="price-detail d-flex justify-content-between">
                        <span class="detail-title">Subtotal ({{ cartItems?.length || 0 }} items)</span>
                        <span class="detail-amt font-weight-bold">{{ getFormattedSubTotal() }} EGP</span>
                      </li>
                      <li class="price-detail d-flex justify-content-between" *ngIf="checkoutData?.discountTotal > 0">
                        <span class="detail-title text-success">Discount</span>
                        <span class="detail-amt text-success font-weight-bold">-{{ checkoutData?.discountTotal || 0 }}
                          EGP</span>
                      </li>
                      <li class="price-detail d-flex justify-content-between">
                        <span class="detail-title">
                          Shipping
                          <span *ngIf="checkoutData?.freeShippingApplied" class="text-success">(Free)</span>
                        </span>
                        <span class="detail-amt font-weight-bold"
                          [class.text-success]="checkoutData?.freeShippingApplied">
                          {{ checkoutData?.freeShippingApplied ? 'Free' : (checkoutData?.shippingTotal || 0) + ' EGP' }}
                        </span>
                      </li>
                    </ul>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between">
                      <span class="detail-title h5 font-weight-bold">Total</span>
                      <span class="detail-amt h5 font-weight-bold text-primary">{{ getFormattedTotal() }} EGP</span>
                    </div>
                  </div>

                  <!-- Checkout Button -->
                  <div class="checkout-action mt-4">
                    <button type="button" class="btn btn-primary btn-block btn-lg" (click)="submitCheckout()"
                      [disabled]="isSubmittingOrder">
                      <span *ngIf="isSubmittingOrder" class="spinner-border spinner-border-sm mr-2"></span>
                      <i *ngIf="!isSubmittingOrder" data-feather="credit-card" class="mr-50"></i>
                      {{ isSubmittingOrder ? 'Processing...' : 'Place Order' }}
                    </button>

                    <button type="button" class="btn btn-outline-secondary btn-block mt-2" (click)="previousStep()"
                      [disabled]="isSubmittingOrder">
                      <i data-feather="arrow-left" class="mr-50"></i>
                      Back to Address
                    </button>
                  </div>

                  <!-- Order Notes -->
                  <div class="order-notes mt-3">
                    <small class="text-muted">
                      <i data-feather="info" class="mr-25"></i>
                      By placing this order, you agree to our terms and conditions.
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Checkout Payment Ends -->
      </div>
    </div>
  </div>